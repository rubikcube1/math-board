<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <!-- さらに一般的な名称に変更 -->
    <title>Academic Study Log</title>
    <style>
        :root {
            --bg: #fafafa;
            --card: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --primary: #0f172a;
            --secondary: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.5;
            min-height: 100vh;
        }

        #main-content { display: none; }
        .hidden { display: none !important; }

        math { font-size: 1.1em; }

        .nav {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        .card {
            background: var(--card);
            padding: 24px;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .input-group { margin-bottom: 20px; }
        .label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 8px 0;
            border: none;
            border-bottom: 1px solid var(--border);
            background: transparent;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus { border-bottom-color: var(--primary); }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .btn:hover { opacity: 0.8; }
        .btn-ghost { background: transparent; color: var(--secondary); border: 1px solid var(--border); }

        .math-symbol-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid var(--border);
            font-size: 12px;
            margin-right: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            border-radius: 3px;
        }

        .post-body { white-space: pre-wrap; word-wrap: break-word; color: #334155; }
        
        .thread-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .auth-screen {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .auth-form { width: 100%; max-width: 320px; }

        .message-item {
            border-left: 2px solid var(--border);
            padding-left: 20px;
            margin-bottom: 32px;
        }

        .message-meta {
            display: flex;
            gap: 12px;
            font-size: 10px;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 8px;
        }
    </style>
</head>
<body>

    <div id="auth-overlay" class="auth-screen">
        <div class="auth-form">
            <h1 style="text-align:center; font-weight:300; margin-bottom:40px; font-size:24px;">Academic Archive</h1>
            <div class="input-group">
                <label class="label">User ID</label>
                <input type="text" id="username-input" autocomplete="off">
            </div>
            <div class="input-group">
                <label class="label">Access Key</label>
                <input type="password" id="password-input" autocomplete="new-password">
            </div>
            <div class="input-group">
                <label class="label">System Code</label>
                <input type="password" id="common-code-input" autocomplete="off">
            </div>
            <button onclick="window.handleAuth()" class="btn" style="width:100%; margin-top:20px;">ACCESS</button>
            <p id="auth-error" style="color:red; font-size:11px; margin-top:20px; text-align:center; display:none;"></p>
        </div>
    </div>

    <div id="main-content">
        <nav class="nav">
            <div style="display:flex; align-items:center; gap:16px;">
                <button id="back-to-threads" onclick="window.showThreadList()" class="hidden btn-ghost" style="padding:4px 8px;">Back</button>
                <span style="font-weight:300; font-size:20px;">Study Archive</span>
            </div>
            <div style="display:flex; align-items:center; gap:16px;">
                <span id="display-username" style="font-size:10px; color:var(--secondary);"></span>
                <button onclick="window.logout()" style="background:none; border:none; font-size:10px; color:#ccc; cursor:pointer;">EXIT</button>
            </div>
        </nav>

        <div class="container">
            <section id="view-thread-list" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:40px;">
                    <h2 class="label">Folder List</h2>
                    <button onclick="window.openThreadModal()" class="btn" style="padding:8px 16px; font-size:12px;">+ New Archive</button>
                </div>
                <div id="threads-container" class="thread-grid"></div>
            </section>

            <section id="view-thread-detail" class="view-section hidden">
                <h2 id="current-thread-title" style="font-weight:300; font-size:28px; margin-bottom:32px;"></h2>

                <div class="card">
                    <div style="margin-bottom:16px;">
                        <button class="math-symbol-btn" onclick="window.insertMath('frac')">分数</button>
                        <button class="math-symbol-btn" onclick="window.insertMath('sqrt')">√</button>
                        <button class="math-symbol-btn" onclick="window.insertMath('pow')">x²</button>
                        <button class="math-symbol-btn" onclick="window.insertMath('pi')">π</button>
                    </div>
                    <textarea id="post-input" rows="4" style="border-bottom:1px solid var(--border); margin-bottom:16px;" placeholder="Add study note..."></textarea>
                    <div style="display:flex; justify-content:flex-end;">
                        <button onclick="window.saveMessage()" class="btn">SAVE</button>
                    </div>
                </div>

                <div id="messages-container"></div>
            </section>
        </div>
    </div>

    <div id="thread-modal" class="auth-screen hidden" style="background: rgba(255,255,255,0.95);">
        <div class="auth-form">
            <h3 style="font-weight:300; margin-bottom:24px;">New Folder Name</h3>
            <input type="text" id="new-thread-title" maxlength="30" style="margin-bottom:40px;">
            <div style="display:flex; justify-content:flex-end; gap:20px;">
                <button onclick="window.closeThreadModal()" class="btn-ghost" style="border:none;">Cancel</button>
                <button onclick="window.createNewThread()" class="btn">CREATE</button>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = "STORAGE_V_101";
        const COMMON_CODE = "6174";

        let state = JSON.parse(localStorage.getItem(DB_KEY)) || { threads: [], messages: {} };
        let myName = "";
        let activeId = null;

        function save() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
        }

        window.handleAuth = () => {
            const u = document.getElementById('username-input').value.trim();
            const p = document.getElementById('password-input').value.trim();
            const c = document.getElementById('common-code-input').value.trim();
            const err = document.getElementById('auth-error');

            if (!u || !p || c !== COMMON_CODE) {
                err.textContent = "DENIED";
                err.style.display = "block";
                return;
            }

            myName = u;
            document.getElementById('display-username').textContent = u;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            if (window.location.search || window.location.hash) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            window.showThreadList();
        };

        window.logout = () => { if(confirm("EXIT?")) window.location.replace(window.location.pathname); };

        window.showThreadList = () => {
            activeId = null;
            document.getElementById('back-to-threads').classList.add('hidden');
            document.getElementById('view-thread-list').classList.remove('hidden');
            document.getElementById('view-thread-detail').classList.add('hidden');
            renderThreads();
        };

        function renderThreads() {
            const container = document.getElementById('threads-container');
            if (state.threads.length === 0) {
                container.innerHTML = `<p style="color:#ccc; font-size:12px; text-align:center; grid-column:1/-1;">EMPTY</p>`;
                return;
            }
            container.innerHTML = state.threads.map(t => `
                <div onclick="window.openThread('${t.id}')" class="card" style="cursor:pointer;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <h3 style="font-size:18px;">${t.title}</h3>
                        <button onclick="event.stopPropagation(); window.deleteThread('${t.id}')" style="background:none; border:none; color:#eee; cursor:pointer;">×</button>
                    </div>
                    <div style="margin-top:20px; font-size:10px; color:#ccc;">${t.createdAt}</div>
                </div>
            `).reverse().join('');
        }

        window.deleteThread = (id) => {
            if(confirm("DELETE?")) {
                state.threads = state.threads.filter(t => t.id !== id);
                delete state.messages[id];
                save();
                renderThreads();
            }
        };

        window.openThreadModal = () => document.getElementById('thread-modal').classList.remove('hidden');
        window.closeThreadModal = () => document.getElementById('thread-modal').classList.add('hidden');

        window.createNewThread = () => {
            const input = document.getElementById('new-thread-title');
            const title = input.value.trim();
            if (!title) return;
            const id = "i_" + Date.now();
            state.threads.push({ id, title, createdAt: new Date().toLocaleDateString('ja-JP') });
            state.messages[id] = [];
            save();
            input.value = "";
            window.closeThreadModal();
            renderThreads();
        };

        window.openThread = (id) => {
            activeId = id;
            const thread = state.threads.find(t => t.id === id);
            document.getElementById('current-thread-title').textContent = thread.title;
            document.getElementById('back-to-threads').classList.remove('hidden');
            document.getElementById('view-thread-list').classList.add('hidden');
            document.getElementById('view-thread-detail').classList.remove('hidden');
            renderMessages();
        };

        window.saveMessage = () => {
            const input = document.getElementById('post-input');
            if (!input.value.trim()) return;
            state.messages[activeId].push({
                user: myName,
                content: input.value.trim(),
                time: new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'})
            });
            save();
            input.value = "";
            renderMessages();
        };

        function renderMessages() {
            const container = document.getElementById('messages-container');
            const msgs = state.messages[activeId] || [];
            if (msgs.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#ccc; font-size:10px;">NO NOTES</p>';
                return;
            }
            container.innerHTML = msgs.map(m => `
                <div class="message-item">
                    <div class="message-meta"><span>${m.user}</span><span>${m.time}</span></div>
                    <div class="post-body">${m.content}</div>
                </div>
            `).reverse().join('');
        }

        window.insertMath = (type) => {
            const area = document.getElementById('post-input');
            let snip = "";
            switch(type) {
                case 'frac': snip = '<math><mfrac><mrow>N</mrow><mrow>D</mrow></mfrac></math>'; break;
                case 'sqrt': snip = '<math><msqrt>x</msqrt></math>'; break;
                case 'pow': snip = '<math><msup><mi>x</mi><mn>2</mn></msup></math>'; break;
                case 'pi': snip = '<math><mi>π</mi></math>'; break;
            }
            const pos = area.selectionStart;
            area.value = area.value.slice(0, pos) + snip + area.value.slice(area.selectionEnd);
            area.focus();
        };

        window.onload = () => { if (window.location.hash) window.history.replaceState({}, document.title, window.location.pathname); };
    </script>
</body>
</html>
